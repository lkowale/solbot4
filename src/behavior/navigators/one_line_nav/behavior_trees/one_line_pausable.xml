<!--
  Pausable OneLine Behavior Tree

  Navigates along a single line defined by WGS84 start/end points with pause/resume support.
  Uses SubTrees from approach_swath.xml and swath_nav.xml to keep logic separated.

  Subscribe to /pause topic with solbot4_msgs/msg/Pause to pause/resume.

  To pause:  ros2 topic pub /pause solbot4_msgs/msg/Pause "{paused: true, source: 'operator', reason: 'Manual pause'}"
  To resume: ros2 topic pub /pause solbot4_msgs/msg/Pause "{paused: false, source: 'operator', reason: 'Resuming'}"

  Blackboard variables:
    Input (set by navigator):
      - geo_points: vector of GeoPoint (start, end)

    Output (set by ConvertGeoPoints):
      - map_points: vector of PoseStamped in map frame
-->
<root BTCPP_format="4" main_tree_to_execute="OneLinePausable">
  <!-- Include SubTree behavior tree files -->
  <include path="subtrees/approach_swath.xml"/>
  <include path="subtrees/swath_nav.xml"/>

  <BehaviorTree ID="OneLinePausable">
    <Sequence>
      <!-- Initial conversion -->
      <ConvertGeoPoints geo_points="{geo_points}" map_points="{map_points}"/>

      <!-- Set parameters for SubTrees -->
      <SetBlackboard output_key="approach_planner_id" value="GridBased"/>
      <SetBlackboard output_key="approach_controller_id" value="FollowPath"/>
      <SetBlackboard output_key="approach_path_pub_topic" value="to_start_path"/>
      <SetBlackboard output_key="swath_planner_id" value="StraightLine"/>
      <SetBlackboard output_key="swath_controller_id" value="FollowPath"/>
      <SetBlackboard output_key="swath_path_pub_topic" value="swath_path"/>

      <KeepRunningUntilFailure>
        <ReactiveSequence>
          <!-- Check pause state -->
          <Fallback>
            <NotPaused pause_topic="/pause"/>
            <WaitUntilNotPaused pause_topic="/pause"/>
          </Fallback>

          <Sequence name="Traverse line">
            <!-- Approach: Navigate to swath start (uses approach_swath.xml) -->
            <SubTree ID="ApproachSwath" _autoremap="true"/>

            <!-- Navigate swath: Follow path through all map_points (uses swath_nav.xml) -->
            <SubTree ID="SwathNav" _autoremap="true"/>

            <!-- 180 degree turn -->
            <MoveSequence sequence_file="same_line_turn_fast.json"
                          segment_idx="{segment_idx}"
                          segment_distance_traveled="{seg_trav}"
                          current_segment_idx="{segment_idx}"
                          current_segment_distance="{seg_trav}"/>

            <!-- Reverse geo_points and re-convert to update map_points -->
            <ReverseGeoPoints geo_points="{geo_points}"/>
            <ConvertGeoPoints geo_points="{geo_points}" map_points="{map_points}"/>
          </Sequence>

        </ReactiveSequence>
      </KeepRunningUntilFailure>
    </Sequence>
  </BehaviorTree>
</root>
